# 宝塔面板博客部署修复指南

## 问题描述
生产环境头像无法访问，返回 404 错误。

## 解决方案

### 1. 替换 Nginx 配置

1. **登录宝塔面板**
2. **进入网站管理** → 找到 `blog.lyingshine.top` 网站
3. **点击设置** → **配置文件**
4. **完全替换**现有配置为 `baota-nginx.conf` 中的内容

### 2. 关键修复点

新配置添加了以下关键部分：

```nginx
# 代理上传文件请求（关键修复）
location /uploads/ {
    proxy_pass http://127.0.0.1:3000;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    
    # 文件缓存设置
    expires 1y;
    add_header Cache-Control "public, immutable";
}
```

### 3. 配置说明

#### 后端服务地址
- 配置中使用 `http://127.0.0.1:3000` 作为后端地址
- 如果你的后端运行在不同端口，请修改端口号
- 如果后端在不同服务器，请修改 IP 地址

#### SSL 证书路径
```nginx
ssl_certificate    /www/server/panel/vhost/cert/blog.lyingshine.top/fullchain.pem;
ssl_certificate_key    /www/server/panel/vhost/cert/blog.lyingshine.top/privkey.pem;
```
- 如果证书路径不同，请修改为实际路径
- 如果没有 SSL 证书，可以删除 SSL 相关配置

#### 网站根目录
```nginx
root /www/wwwroot/blog.lyingshine.top;
```
- 确保路径指向你的前端构建文件目录
- 该目录应包含 `index.html` 等前端文件

### 4. 部署步骤

1. **备份当前配置**
   - 在宝塔面板中复制当前 Nginx 配置并保存

2. **应用新配置**
   - 将 `baota-nginx.conf` 内容完全替换到网站配置中
   - 根据实际情况修改后端端口、SSL 证书路径等

3. **重载 Nginx**
   - 点击"保存"后，宝塔会自动重载 Nginx
   - 或手动执行：`nginx -s reload`

4. **验证修复**
   ```bash
   # 测试头像访问
   curl -I https://blog.lyingshine.top/uploads/avatars/5_1758816392983.jpg
   
   # 应该返回 200 状态码
   ```

### 5. 注意事项

1. **确保后端服务运行**
   - 后端应该在 `127.0.0.1:3000` 上运行
   - 可以通过 `curl http://127.0.0.1:3000/api/health` 测试

2. **防火墙设置**
   - 确保 3000 端口在服务器内部可访问
   - 不需要对外开放 3000 端口

3. **文件权限**
   - 确保 Nginx 有权限访问网站根目录
   - 确保后端有权限访问 uploads 目录

### 6. 故障排除

如果修复后仍有问题：

1. **查看 Nginx 错误日志**
   ```bash
   tail -f /www/wwwlogs/blog.lyingshine.top.error.log
   ```

2. **检查后端服务状态**
   ```bash
   curl http://127.0.0.1:3000/api/health
   ```

3. **测试代理连接**
   ```bash
   curl -I http://127.0.0.1:3000/uploads/avatars/5_1758816392983.jpg
   ```

4. **重启相关服务**
   - 重启 Nginx：`systemctl restart nginx`
   - 重启后端服务（根据你的部署方式）

## 完成后验证

修复成功后，访问 `https://blog.lyingshine.top/uploads/avatars/xxx.jpg` 应该能正常显示头像，而不是 404 错误。